


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="http://lastweek.io/notes/dynamic_linking/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.2">
    
    
      
        <title>Dynamic Linking - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a2408e81.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime+Bold:300,400,400i,700%7CCourier+Prime+Bold&display=fallback">
        <style>body,input{font-family:"Courier Prime Bold",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Courier Prime Bold",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dynamic-linking" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Yizhou Shan's Home Page
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Dynamic Linking
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../source_code/summary/" class="md-tabs__link">
          Code Study
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../cache_coherence/" class="md-tabs__link md-tabs__link--active">
          Tech Notes
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../fpga/bitstream/" class="md-tabs__link">
          FPGAs
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../lego/log/misc/" class="md-tabs__link">
          LegoOS Notes
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../financial/stock/" class="md-tabs__link">
          Financial
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Code Study
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Code Study" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Code Study
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/summary/" title="All-in-One" class="md-nav__link">
      All-in-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../program_advice/" title="Guideline & Advice" class="md-nav__link">
      Guideline & Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/os/" title="OS" class="md-nav__link">
      OS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/virt/" title="Virtualization" class="md-nav__link">
      Virtualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/rdma/" title="DPDK and RDMA" class="md-nav__link">
      DPDK and RDMA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/firmware-softwares/" title="Firmware and Bootloader" class="md-nav__link">
      Firmware and Bootloader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/20200501-on-graphic-softwares/" title="Graphics" class="md-nav__link">
      Graphics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/gpu/" title="GPU" class="md-nav__link">
      GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/fpga/" title="FPGA" class="md-nav__link">
      FPGA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/misc/" title="Misc" class="md-nav__link">
      Misc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/dotconfigs/" title="Terminal Configs" class="md-nav__link">
      Terminal Configs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/commands/" title="Terminal Commands" class="md-nav__link">
      Terminal Commands
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Tech Notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tech Notes" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tech Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cache_coherence/" title="Practical Cache Coherence" class="md-nav__link">
      Practical Cache Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../packet-sched/" title="Switch Buffering and Packet Scheduling" class="md-nav__link">
      Switch Buffering and Packet Scheduling
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Dynamic Linking
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Dynamic Linking" class="md-nav__link md-nav__link--active">
      Dynamic Linking
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#c-start-up-csu" class="md-nav__link">
    C Start Up (csu)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-linking-in-user-space" class="md-nav__link">
    Dynamic Linking in User Space
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Linking in User Space">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldso" class="md-nav__link">
    ld.so
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding" class="md-nav__link">
    Understanding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-kernel-loads-user-program" class="md-nav__link">
    How Kernel Loads User Program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-kernel-loads-kernel-module" class="md-nav__link">
    How Kernel Loads Kernel Module
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/virt/" title="Virtualization" class="md-nav__link">
      Virtualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../arch/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cryptography/" title="Cryptography" class="md-nav__link">
      Cryptography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cryptocurrency/" title="Cryptocurrency" class="md-nav__link">
      Cryptocurrency
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hardware_pl/" title="Hardware Design Languages" class="md-nav__link">
      Hardware Design Languages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-iouring/" title="Linux io_uring" class="md-nav__link">
      Linux io_uring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-boot/" title="Linux Boot Sequence" class="md-nav__link">
      Linux Boot Sequence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trace/" title="Linux Trace and Profile" class="md-nav__link">
      Linux Trace and Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rmap/" title="Linux Reverse Mapping" class="md-nav__link">
      Linux Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../xperf/" title="Linux x86 Ring Switch" class="md-nav__link">
      Linux x86 Ring Switch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-x86-fpu/" title="Linux FPU" class="md-nav__link">
      Linux FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blog/20200404-on-read-once/" title="On Read Once and Compiler Optimization" class="md-nav__link">
      On Read Once and Compiler Optimization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-24" type="checkbox" id="nav-3-24">
    
    <label class="md-nav__link" for="nav-3-24">
      Languages
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Languages" data-md-level="2">
      <label class="md-nav__title" for="nav-3-24">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Languages
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../languages/rust/" title="Rust" class="md-nav__link">
      Rust
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGAs
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="FPGAs" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        FPGAs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/language/" title="Languages" class="md-nav__link">
      Languages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/vivado/" title="Vivado Notes" class="md-nav__link">
      Vivado Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/setup_hold/" title="Setup and Hold Time" class="md-nav__link">
      Setup and Hold Time
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/pr/" title="Partial Reconfiguration" class="md-nav__link">
      Partial Reconfiguration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      LegoOS Notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="LegoOS Notes" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        LegoOS Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Log
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Log" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Log
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/log/misc/" title="MISC" class="md-nav__link">
      MISC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/log/test-note/" title="Test Script" class="md-nav__link">
      Test Script
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Kernel
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Kernel" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Syscall
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Syscall" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Pcache
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Pcache" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Driver
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Driver" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      Paper
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Paper" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Financial
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Financial" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Financial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../financial/stock/" title="Stock" class="md-nav__link">
      Stock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../financial/economics_behavior/" title="Behavior Economics" class="md-nav__link">
      Behavior Economics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../financial/economics/" title="Economics" class="md-nav__link">
      Economics
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#c-start-up-csu" class="md-nav__link">
    C Start Up (csu)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-linking-in-user-space" class="md-nav__link">
    Dynamic Linking in User Space
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Linking in User Space">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldso" class="md-nav__link">
    ld.so
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding" class="md-nav__link">
    Understanding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-kernel-loads-user-program" class="md-nav__link">
    How Kernel Loads User Program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-kernel-loads-kernel-module" class="md-nav__link">
    How Kernel Loads Kernel Module
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="dynamic-linking">Dynamic Linking<a class="headerlink" href="#dynamic-linking" title="Permanent link">&para;</a></h1>
<details class="note"><summary>Version History</summary><table>
<thead>
<tr>
<th align="left">Date</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Jan 01, 2021</td>
<td>Add kernel module loading part</td>
</tr>
<tr>
<td align="left">Dec 24, 2020</td>
<td>Adopted from my previous <a href="https://github.com/lastweek/source-glibc">note</a></td>
</tr>
</tbody>
</table>
</details>
<p><img alt="🚣" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f6a3.svg" title=":rowboat:" /></p>
<p>This blog looks at some part of the user-space dynamic linker,
how kernel loads user program, and how kernel loads kernel modules.</p>
<hr />
<h2 id="c-start-up-csu">C Start Up (csu)<a class="headerlink" href="#c-start-up-csu" title="Permanent link">&para;</a></h2>
<p>For code pointers, see the glibc code <a href="https://github.com/lastweek/source-glibc">here</a>.</p>
<p>In glibc:</p>
<ul>
<li><code>csu/libc-start.c</code></li>
<li><code>__libc_start_main()</code> is the entry point.
  Inside, it will call <code>__libc_csu_init()</code>.
  Then it will call user&rsquo;s <code>main()</code>.</li>
<li>Great reference: <a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux x86 Program Start Up</a>.
  I saved a printed <a href="../assets/Linux-x86-Program-Start-Up.pdf">PDF copy</a> in this repo.</li>
</ul>
<h2 id="dynamic-linking-in-user-space">Dynamic Linking in User Space<a class="headerlink" href="#dynamic-linking-in-user-space" title="Permanent link">&para;</a></h2>
<p>The dynamic linker/loader <code>ld.so</code> is part of glibc.</p>
<p>I was particularly interested in how it resolves the dynamic symbols during
runtime. I took a brief read of the source code and found some relevant ones.</p>
<h3 id="ldso">ld.so<a class="headerlink" href="#ldso" title="Permanent link">&para;</a></h3>
<ul>
<li>ELF&rsquo;s <code>.interp</code> section points to the dynamic linker, and here it is.</li>
<li>Related code: <code>elf/rtld.c</code>, <code>sysdep/generic</code>, <code>sysdep/x86_64/</code>, and more</li>
<li>Inside <code>dl_main()</code>, you can see how <code>LD_PRELOAD</code> is handled.</li>
<li><code>GOT[1]</code> contains address of the <code>link_map</code> data structure.</li>
<li><code>GOT[2]</code> points to <code>_dl_runtime_resolve()</code>! This is the runtime dynamic linker entry point.</li>
</ul>
<p>File <code>sysdep/generic/dl-machine.c</code> populates <code>GOT[1]</code> and <code>GOT[2]</code>.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/* Set up the loaded object described by L so its unrelocated PLT</span>
<span class="cm">   entries will jump to the on-demand fixup code in dl-runtime.c.  */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">elf_machine_runtime_setup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lazy</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">extern</span> <span class="kt">void</span> <span class="n">_dl_runtime_resolve</span> <span class="p">(</span><span class="n">Elf32_Word</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">lazy</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* The GOT entries for functions in the PLT have not yet been filled</span>
<span class="cm">         in.  Their initial contents will arrange when called to push an</span>
<span class="cm">         offset into the .rel.plt section, push _GLOBAL_OFFSET_TABLE_[1],</span>
<span class="cm">         and then jump to _GLOBAL_OFFSET_TABLE[2].  */</span>
      <span class="n">Elf32_Addr</span> <span class="o">*</span><span class="n">got</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">D_PTR</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l_info</span><span class="p">[</span><span class="n">DT_PLTGOT</span><span class="p">]);</span>
<span class="hll">      <span class="n">got</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Addr</span><span class="p">)</span> <span class="n">l</span><span class="p">;</span>  <span class="cm">/* Identify this shared object.  */</span>
</span>
      <span class="cm">/* This function will get called to fix up the GOT entry indicated by</span>
<span class="cm">         the offset on the stack, and then jump to the resolved address.  */</span>
<span class="hll">      <span class="n">got</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Addr</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_dl_runtime_resolve</span><span class="p">;</span>
</span>    <span class="p">}</span>

  <span class="k">return</span> <span class="n">lazy</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></p>
<p><code>_dl_runtime_resolve()</code> is architecture specific and has a mix of assembly and C code.
The flow is similar to the syscall handling: it first saves the registers,
then calling the actual resolver, then restore all saved registers.
For 64bit x86, the source code is in <code>sysdeps/x86_64/dl-trampoline.h</code>:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="na">.globl</span> <span class="no">_dl_runtime_resolve</span>
    <span class="na">.type</span> <span class="no">_dl_runtime_resolve</span><span class="p">,</span> <span class="na">@function</span>
<span class="nl">_dl_runtime_resolve:</span>
    <span class="na">...</span>
    <span class="na">...</span>

    <span class="c1"># Copy args pushed by PLT in register.</span>
    <span class="c1"># %rdi: link_map, %rsi: reloc_index</span>
    <span class="nf">mov</span> <span class="p">(</span><span class="no">LOCAL_STORAGE_AREA</span> <span class="err">+</span> <span class="mi">8</span><span class="p">)(</span><span class="nv">%BASE</span><span class="p">),</span> <span class="nv">%RSI_LP</span>
    <span class="nf">mov</span> <span class="no">LOCAL_STORAGE_AREA</span><span class="p">(</span><span class="nv">%BASE</span><span class="p">),</span> <span class="nv">%RDI_LP</span>
<span class="hll">    <span class="nf">call</span> <span class="no">_dl_fixup</span>      <span class="c1"># Call resolver.</span>
</span>    <span class="nf">mov</span> <span class="nv">%RAX_LP</span><span class="p">,</span> <span class="nv">%R11_LP</span>    <span class="c1"># Save return value</span>

    <span class="na">...</span>
</code></pre></div>
</td></tr></table></p>
<p>Bingo, <code>_dl_fixup()</code> is the final piece of the runtime dynamic linker resolver. We could find it in <code>elf/dl-runtime.c</code>, which is a file for on-demand PLT fixup.:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/* This function is called through a special trampoline from the PLT the</span>
<span class="cm">   first time each PLT entry is called.  We must perform the relocation</span>
<span class="cm">   specified in the PLT of the given shared object, and return the resolved</span>
<span class="cm">   function address to the trampoline, which will restart the original call</span>
<span class="cm">   to that address.  Future calls will bounce directly from the PLT to the</span>
<span class="cm">   function.  */</span>

<span class="n">DL_FIXUP_VALUE_TYPE</span>
<span class="n">attribute_hidden</span> <span class="nf">__attribute</span> <span class="p">((</span><span class="n">noinline</span><span class="p">))</span> <span class="n">ARCH_FIXUP_ATTRIBUTE</span>
<span class="n">_dl_fixup</span> <span class="p">(</span>
<span class="cp"># ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS</span>
       <span class="n">ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><span class="p">,</span>
<span class="cp"># endif</span>
       <span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Word</span><span class="p">)</span> <span class="n">reloc_arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></p>
<p>Understanding this piece of code requires some effort. Happy hacking!</p>
<h3 id="understanding">Understanding<a class="headerlink" href="#understanding" title="Permanent link">&para;</a></h3>
<p>Most recent ELF produced by GCC is slightly different than
the ones described by previous textbook or papers.
The difference is small, though. You should use <code>man elf</code> to check latest.</p>
<ul>
<li>When a program imports a certain function or variable, the linker
  will include a string with the function or variable’s name in the
  <code>.dynstr</code> section.</li>
<li>A symbol (Elf Sym) that refers to the function or variable&rsquo;s name in the <code>.dynsym</code> section,
  and a relocation (Elf Rel) pointing to that symbol in the <code>.rela.plt</code> section.</li>
<li><code>.rela.dyn</code> and <code>.rela.plt</code> are for imported variables and functions, respectively.</li>
<li><code>.plt</code> is the normal one, it has instructions.</li>
<li><code>.got</code> and <code>.got.plt</code> maybe the first is for variable, and the latter is for function.
  But essentially the same global offset table functionality.</li>
</ul>
<p>Relationship among <code>.dynstr</code>, <code>.dynsym</code>, <code>.rela.dyn</code> or <code>.rela.plt</code>. Credit: <a href="https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-di-frederico.pdf">link</a>:
<img alt="image1" src="../assets/relation.png" /></p>
<p>PIC Lazy Binding. Credit: <a href="https://uclibc.org/docs/psABI-x86_64.pdf">link</a>:
<img alt="image2" src="../assets/gotplt.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<p>GOT and PLT were invented for share libraries,
so those libraries can be used by arbitrary processes
without changing any of the library text.</p>
<p>However, nowadays, even an non-PIC binary will always have GOT and PLT sections.
In theory, it probably should use <strong>basic load-time relocation</strong>
to resolve dynamic symbols (See <a href="https://csapp.cs.cmu.edu/">CSAPP</a> chapter 7 if you are not familiar with this).</p>
<p>I think GOT/PLT are used over load-time relocation technique for the following 2 reasons:
a) load-time relocation needs to
modify code and this not good during time.
Especially considering code section probably is not writable.
b) GOT/PLT&rsquo;s lazy-binding has performance win at start-up time.
However, keep in mind that
GOT/PLT&rsquo;s lazy-bindling pay extra runtime cost!</p>
<p>Reading:</p>
<ul>
<li><a href="https://uclibc.org/docs/psABI-x86_64.pdf">System V Application Binary Interface</a></li>
<li><a href="https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-di-frederico.pdf">How the ELF Ruined Christmas</a></li>
</ul>
<h2 id="how-kernel-loads-user-program">How Kernel Loads User Program<a class="headerlink" href="#how-kernel-loads-user-program" title="Permanent link">&para;</a></h2>
<p>Kernel loads user program via <code>exec()</code> or some variations.
This <a href="../../lego/kernel/loader/">post</a> explained the flow in great details.</p>
<p>Note that kernel can recognize dynamic linking via the <code>.interp</code> section
and then invoke the dynamic linker <code>ld.so</code> instead of invoking user ELF binary directly.</p>
<h2 id="how-kernel-loads-kernel-module">How Kernel Loads Kernel Module<a class="headerlink" href="#how-kernel-loads-kernel-module" title="Permanent link">&para;</a></h2>
<p>Kernel can load modules during runtime.
Those modules are ELF binaries.
Let&rsquo;s first examine those binaries and see how kernel parses them.</p>
<p>Suppose we have this simple C module code:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hello_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">foo</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></p>
<p>Once you compile it into a kernel module, we can examine the binary
by using <code>objdump -dx hello.ko</code>.
Those highlighted lines mark some of the dynamic linking slots.
They will be patched by basic load-time relocation.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Disassembly of section .text.unlikely:

0000000000000000 &lt;foo&gt;:
   0:   e8 00 00 00 00          callq  5 &lt;foo+0x5&gt;
                        1: R_X86_64_PLT32       __fentry__-0x4
   5:   55                      push   %rbp
   6:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi
                        9: R_X86_64_32S .rodata.str1.1
   d:   48 89 e5                mov    %rsp,%rbp
  10:   e8 00 00 00 00          callq  15 &lt;foo+0x15&gt;
                        11: R_X86_64_PLT32      printk-0x4
  15:   5d                      pop    %rbp
  16:   c3                      retq   

0000000000000017 &lt;init_module&gt;:
  17:   e8 00 00 00 00          callq  1c &lt;init_module+0x5&gt;
                        18: R_X86_64_PLT32      __fentry__-0x4
  1c:   55                      push   %rbp
<span class="hll">  1d:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi
</span><span class="hll">                        20: R_X86_64_32S        .rodata.str1.1
</span><span class="hll">  24:   48 89 e5                mov    %rsp,%rbp
</span><span class="hll">  27:   e8 00 00 00 00          callq  2c &lt;init_module+0x15&gt;
</span><span class="hll">                        28: R_X86_64_PLT32      printk-0x4
</span>  2c:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi
                        2f: R_X86_64_32S        .rodata.str1.1
  33:   e8 00 00 00 00          callq  38 &lt;init_module+0x21&gt;
                        34: R_X86_64_PLT32      printk-0x4
  38:   e8 00 00 00 00          callq  3d &lt;init_module+0x26&gt;
                        39: R_X86_64_PLT32      foo-0x4
  3d:   31 c0                   xor    %eax,%eax
  3f:   5d                      pop    %rbp
  40:   c3                      retq   
</code></pre></div>
</td></tr></table></p>
<p>It is also worth checking out the <code>.symtab</code> section.
If your module is using kernel functions or variables,
the compiler does not know their precise addresses during compile time.
The compiler will add several entries into the <code>.symtab</code> with properties
marked as <code>GLOBAL, UND</code>. For example, you can run <code>readelf -s hello.ko</code>
to check that. I will post part of the output:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Symbol table &#39;.symtab&#39; contains 29 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 
    ....
    13: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS haha.mod.c
    ....
    21: 0000000000000017    42 FUNC    LOCAL  DEFAULT    5 hello_init
    22: 0000000000000000    11 FUNC    LOCAL  DEFAULT    3 hello_exit
    23: 0000000000000000   896 OBJECT  GLOBAL DEFAULT   12 __this_module
    24: 0000000000000000    11 FUNC    GLOBAL DEFAULT    3 cleanup_module
    25: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND __fentry__
    26: 0000000000000017    42 FUNC    GLOBAL DEFAULT    5 init_module
    27: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND printk
    28: 0000000000000000    23 FUNC    GLOBAL DEFAULT    5 foo
</code></pre></div>
</td></tr></table></p>
<p>The <code>simplify_symbols()</code> below will find the kernel virtual addresses
for UNDEF symbols in the <code>.symtab</code> section. Those will further be
used to patch dynamic relocation entries.</p>
<hr />
<p>Now let us dive into kernel implementation.</p>
<p>The kernel has several system calls for module.
The loading part is using <code>SYSCALL_DEFINE3(init_module)</code>.
Within that, it calls the big function <code>load_module()</code>.</p>
<p>In the begining of <code>load_module()</code>, there are some
usual tasks examining ELF headers, allocating memory etc.
After that, kernel will try to find the addresses for UNDEF symbols:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">c</span> <span class="n">load_module</span><span class="p">()</span>
        <span class="cm">/* Fix up syms, so that st_value is a pointer to location. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">simplify_symbols</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">free_modinfo</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocations</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">free_modinfo</span><span class="p">;</span>

<span class="o">==&gt;</span>

<span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">find</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">virtual</span> <span class="n">addresses</span>
<span class="k">for</span> <span class="n">UNDEF</span> <span class="n">symbols</span> <span class="n">in</span> <span class="n">the</span> <span class="err">`</span><span class="p">.</span><span class="n">symtab</span><span class="err">`</span> <span class="n">section</span><span class="p">.</span>

<span class="n">simplify_symbols</span><span class="p">()</span>
              <span class="k">case</span> <span class="nl">SHN_UNDEF</span><span class="p">:</span>
                        <span class="n">ksym</span> <span class="o">=</span> <span class="n">resolve_symbol_wait</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
                        <span class="cm">/* Ok if resolved.  */</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ksym</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ksym</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">sym</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">st_value</span> <span class="o">=</span> <span class="n">kernel_symbol_value</span><span class="p">(</span><span class="n">ksym</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>After resolving symbols to the real kernel virtual addresses,
the next step is to patch the code to update all the relocation entries.
If will do so for sections with these two types: <code>SHT_REL</code> and <code>SHT_RELA</code>.
It looks like x86_64 is only using <code>apply_relocate_add()</code>, the one with explict addends.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">c</span> <span class="n">apply_relocations</span><span class="p">()</span>
        <span class="p">...</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_REL</span><span class="p">)</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span>
                                             <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_RELA</span><span class="p">)</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocate_add</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span>
                                                 <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
</code></pre></div>
</td></tr></table></p>
<p>Zoom into <code>apply_relocate_add()</code>, very interesting function.
It is similar to the userspace linker ld.so.
It could be summarized as follows:</p>
<ul>
<li>Find the start of the relocation entry section in ELF.</li>
<li>Walk through each relocation entry, for each entry, do:<ul>
<li>Get the location where we need to patch the code (e.g., the assembly instructions dumped above)</li>
<li>Find the symbol the entry is using. The symbol was alread resolved to kernel virtual address</li>
<li>Update the location by applying certain computation on top of the resolved symbol address.
  The computation is dictated by entry type (e.g., <code>R_X86_64_PLT32</code>)</li>
</ul>
</li>
</ul>
<p>See the full kernel code <a href="https://elixir.bootlin.com/linux/v5.10.4/source/arch/x86/kernel/module.c#L129">here</a>.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>There you have it. We walk through how kernel loads user program, how kernel loads kernel module,
and how dynamic linker resolves dynamic linking. The kernel and ld.so share a lot similarities
in dealing with the linking process.</p>
<p>We have not covered the static linking part in this post, but its process is
similar to how the basic load-time relocation patches instructions.</p>
<p>The essense of linking and loading is to do lazy information binding
and pass information along the toolchain.
The whole concetps involves many parties, ranging from compiler, linker, and kernel.
Each takes its own part in the process.</p>
<p>As always, hope you enjoyed this blog. Happy Hacking!</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: January 19, 2021
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="http://lastweek.io/notes/dynamic_linking/",this.page.identifier="/notes/dynamic_linking/"};!function(){var e=document,i=e.createElement("script");i.src="//lastweek-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../packet-sched/" title="Switch Buffering and Packet Scheduling" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Switch Buffering and Packet Scheduling
              </div>
            </div>
          </a>
        
        
          <a href="../source_code/virt/" title="Virtualization" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Virtualization
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["instant", "tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>